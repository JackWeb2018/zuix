#!/usr/bin/env bash
set -e # Exit with nonzero exit code if anything fails

PACKAGE_NAME="zUIx"
CURRENT_VERSION=`grep '"version":' package.json | cut -d\" -f4`

function doCompile {
  gulp
}

function publishPackages {
    # publish zuix dev package
    npm publish
    # publish zuix-dist package
    cd dist
    npm publish
    cd ..
}

function deployWebSite {
    # Now let's go have some fun with the cloned repo
    # Copy ZUIX API JSDocs data files (JSON)
    cp -rfv _docs/* docs/app/
    # Copy ZUIX dist files
    cp -rfv dist/js docs/js

    # Version number increment in the Download page
    node ../node_modules/replace/bin/replace.js "${PACKAGE_NAME} v\\d+\\.\\d+\\.\\d+\\-\\d+" "${PACKAGE_NAME} v${CURRENT_VERSION}" ./docs/index.html
}

doCompile

echo "-----"
echo "TRAVIS_PULL_REQUEST = $TRAVIS_PULL_REQUEST"
echo "TRAVIS_BRANCH = $TRAVIS_BRANCH"
echo "TRAVIS_TAG = $TRAVIS_TAG"
echo "TRAVIS_BUILD_NUMBER = $TRAVIS_BUILD_NUMBER"
echo "-----"

# Verify conditions for deploy
if [ "$TRAVIS_PULL_REQUEST" = "false" ] && [ "$TRAVIS_BRANCH" = "$TRAVIS_TAG" ]; then
    # revert local changes generated by previous tests (doCompile)
    git checkout .
    # deploy to docs folder
    echo "Deploying new release $TRAVIS_TAG to website ('docs' folder)..."
    echo ""
    deployWebSite
    echo ""
    echo "... done!"
    # npm publish disabled - TODO: to be fixed / tested
    #publishPackages
    echo "-----"
    echo "Automatic NPM publishing is disabled, do not forget to"
    echo "manually run 'npm publish' both from './' and './dist' folders"
    echo "-----"
fi
